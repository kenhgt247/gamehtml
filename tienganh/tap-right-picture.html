<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap the Right Picture</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #FFF3E0;
            --primary: #FF9800;
            --secondary: #4DB6AC;
            --accent: #E91E63;
            --text: #37474F;
            --card-bg: #FFFFFF;
            --font-main: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            background-color: var(--bg-color);
            font-family: var(--font-main);
            color: var(--text);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI UTILS --- */
        .hidden { display: none !important; }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg-color);
            z-index: 10;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .btn {
            background: var(--primary); color: white;
            border: none; border-radius: 50px;
            padding: 12px 30px; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 5px 0 #E65100; cursor: pointer;
            margin: 10px; transition: transform 0.1s;
            font-family: inherit;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-small { padding: 8px 15px; font-size: 1rem; box-shadow: 0 3px 0 #E65100; }
        .btn-home { background: var(--secondary); box-shadow: 0 5px 0 #00695C; }

        /* --- HEADER / HUD --- */
        #hud {
            width: 100%; height: 70px;
            background: #FFF;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 5;
        }
        .stat-group { display: flex; gap: 10px; align-items: center; font-weight: bold; }
        .hearts { color: var(--accent); letter-spacing: 2px; font-size: 1.5rem; }
        
        /* --- TARGET BAR --- */
        #target-bar {
            background: #FFF8E1;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #FFE0B2;
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        #target-word { font-size: 2rem; font-weight: 900; color: var(--accent); text-transform: uppercase; }
        .speak-btn {
            background: var(--secondary); color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 0 #004D40;
        }
        .speak-btn:active { transform: translateY(2px); box-shadow: none; }

        /* --- GAME GRID --- */
        #game-area {
            flex: 1;
            width: 100%; max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            overflow-y: auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        #card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
        }
        
        @media (min-width: 500px) { #card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 800px) { #card-grid { grid-template-columns: repeat(4, 1fr); gap: 20px; } }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            border: 4px solid transparent;
            position: relative;
        }
        .card:active { transform: scale(0.95); }
        
        /* Animations */
        .card.shake { animation: shake 0.5s; border-color: #F44336; background: #FFEBEE; }
        .card.correct { animation: pop 0.4s; border-color: #4CAF50; background: #E8F5E9; pointer-events: none; }
        .card.hint-active { animation: blink 1s infinite; border-color: #FFD600; background: #FFFDE7; }

        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 
            50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* --- MAP SCREEN --- */
        #level-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;
        }
        .level-node {
            background: #FFF; width: 70px; height: 70px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
            border: 3px solid #ccc; color: #aaa; pointer-events: none;
            position: relative;
        }
        .level-node.unlocked {
            border-color: var(--primary); color: var(--text); cursor: pointer; pointer-events: auto;
            box-shadow: 0 4px 0 #E65100;
        }
        .level-node.unlocked:active { transform: translateY(4px); box-shadow: none; }
        .level-node .stars { font-size: 0.8rem; margin-top: 2px; }

        /* --- MODALS --- */
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 400px;
        }
        h1 { color: var(--primary); margin: 0 0 10px 0; text-shadow: 2px 2px 0 #FFE0B2; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1>Tap the Right Picture</h1>
        <div style="font-size: 5rem; margin: 20px;">üê∂üé®üçé</div>
        <p>Learn words & Have fun!</p>
        <button class="btn" onclick="game.showMap()">PLAY</button>
        <button class="btn btn-home" onclick="game.resetData()">Reset Data</button>
    </div>

    <div id="map-screen" class="screen hidden">
        <h1>Select Level</h1>
        <div id="level-grid"></div>
        <button class="btn btn-home" onclick="game.showStart()">Back</button>
    </div>

    <div id="game-screen" class="screen hidden" style="justify-content: flex-start; padding: 0;">
        <div id="hud">
            <div class="stat-group">
                <button class="btn btn-small btn-home" onclick="game.showMap()">üè†</button>
                <span>Lv.<span id="hud-level">1</span></span>
            </div>
            <div class="stat-group">
                <span id="hud-hearts" class="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            </div>
            <div class="stat-group">
                <span>Score: <span id="hud-score">0</span></span>
                <button class="btn btn-small" id="btn-hint" onclick="game.useHint()">üí° 3</button>
            </div>
        </div>

        <div id="target-bar">
            <span>Find:</span>
            <span id="target-word">CAT</span>
            <button class="speak-btn" onclick="game.speakTarget()">üîä</button>
        </div>

        <div id="game-area">
            <div id="card-grid"></div>
        </div>
    </div>

    <div id="win-screen" class="screen hidden">
        <h1>Good Job! üéâ</h1>
        <h2 id="win-score">Score: 100</h2>
        <div style="font-size: 4rem; margin: 10px;">‚≠ê‚≠ê‚≠ê</div>
        <button class="btn" onclick="game.nextLevel()">Next Level ‚ñ∂</button>
        <button class="btn btn-home" onclick="game.showMap()">Map</button>
    </div>

    <div id="lose-screen" class="screen hidden">
        <h1 style="color: #F44336;">Oops! üò¢</h1>
        <p>Out of hearts</p>
        <button class="btn" onclick="game.retryLevel()">Try Again ‚Ü∫</button>
        <button class="btn btn-home" onclick="game.showMap()">Map</button>
    </div>

    <script>
        // --- DATA ---
        const DATABASE = [
            { word: "APPLE", emoji: "üçé" }, { word: "BANANA", emoji: "üçå" }, { word: "GRAPE", emoji: "üçá" },
            { word: "ORANGE", emoji: "üçä" }, { word: "CAT", emoji: "üê±" }, { word: "DOG", emoji: "üê∂" },
            { word: "MOUSE", emoji: "üê≠" }, { word: "LION", emoji: "ü¶Å" }, { word: "CAR", emoji: "üöó" },
            { word: "BUS", emoji: "üöå" }, { word: "PLANE", emoji: "‚úàÔ∏è" }, { word: "BALL", emoji: "‚öΩ" },
            { word: "STAR", emoji: "‚≠ê" }, { word: "SUN", emoji: "‚òÄÔ∏è" }, { word: "MOON", emoji: "üåô" },
            { word: "FLOWER", emoji: "üå∏" }, { word: "TREE", emoji: "üå≥" }, { word: "FISH", emoji: "üêü" },
            { word: "BIRD", emoji: "üê¶" }, { word: "BEAR", emoji: "üêª" }, { word: "PIG", emoji: "üê∑" },
            { word: "COW", emoji: "üêÆ" }, { word: "TIGER", emoji: "üêØ" }, { word: "BOOK", emoji: "üìñ" },
            { word: "PEN", emoji: "üñäÔ∏è" }, { word: "PHONE", emoji: "üì±" }, { word: "TV", emoji: "üì∫" },
            { word: "CAKE", emoji: "üéÇ" }, { word: "PIZZA", emoji: "üçï" }, { word: "BURGER", emoji: "üçî" }
        ];

        // --- AUDIO ENGINE ---
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: function(freq, type, duration) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playCorrect: function() {
                this.playTone(600, 'sine', 0.1);
                setTimeout(() => this.playTone(800, 'sine', 0.2), 100);
            },
            playWrong: function() {
                this.playTone(150, 'sawtooth', 0.3);
            },
            speak: function(text) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        };

        // --- GAME LOGIC ---
        class Game {
            constructor() {
                this.level = 1;
                this.maxLevel = 10;
                this.score = 0;
                this.hearts = 3;
                this.hints = 3;
                this.target = null;
                this.items = []; // Current cards
                this.isLocked = false;
                this.storageKey = 'tap_right_pic_data';
            }

            // Persistence
            loadData() {
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : { unlocked: 1, scores: {} };
            }
            saveData(level, score) {
                const data = this.loadData();
                if (level >= data.unlocked && level < this.maxLevel) data.unlocked = level + 1;
                if (!data.scores[level] || score > data.scores[level]) data.scores[level] = score;
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }
            resetData() {
                if(confirm("Reset all progress?")) {
                    localStorage.removeItem(this.storageKey);
                    alert("Data reset!");
                    this.showStart();
                }
            }

            // Navigation
            hideAll() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); }
            
            showStart() {
                this.hideAll();
                document.getElementById('start-screen').classList.remove('hidden');
            }

            showMap() {
                this.hideAll();
                const data = this.loadData();
                const grid = document.getElementById('level-grid');
                grid.innerHTML = '';
                
                for(let i=1; i<=this.maxLevel; i++) {
                    const node = document.createElement('div');
                    const isUnlocked = i <= data.unlocked;
                    node.className = `level-node ${isUnlocked ? 'unlocked' : ''}`;
                    node.innerHTML = `<div>${i}</div>`;
                    
                    if (data.scores[i]) {
                        node.innerHTML += `<div class="stars">‚≠ê ${data.scores[i]}</div>`;
                    } else if (!isUnlocked) {
                        node.innerHTML += `<div class="stars">üîí</div>`;
                    }

                    if(isUnlocked) node.onclick = () => this.startLevel(i);
                    grid.appendChild(node);
                }
                document.getElementById('map-screen').classList.remove('hidden');
            }

            // Level Logic
            startLevel(lvl) {
                this.level = lvl;
                this.hearts = 3;
                this.hints = 3;
                this.score = 0;
                this.isLocked = false;
                
                // Determine difficulty (number of cards)
                let cardCount = 6;
                if (lvl > 3) cardCount = 8;
                if (lvl > 7) cardCount = 10;

                this.generateContent(cardCount);
                this.updateHUD();
                
                this.hideAll();
                document.getElementById('game-screen').classList.remove('hidden');
                
                // Speak target after a slight delay
                setTimeout(() => this.speakTarget(), 500);
            }

            generateContent(count) {
                // Select items
                const shuffledDb = [...DATABASE].sort(() => 0.5 - Math.random());
                this.items = shuffledDb.slice(0, count);
                
                // Pick target
                this.target = this.items[Math.floor(Math.random() * this.items.length)];
                
                // Render UI
                document.getElementById('target-word').innerText = this.target.word;
                
                const grid = document.getElementById('card-grid');
                grid.innerHTML = '';
                
                // Adjust grid cols based on count if needed logic (css handles most)
                this.items.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerText = item.emoji;
                    card.dataset.word = item.word;
                    card.onclick = (e) => this.handleCardClick(e.target, item);
                    // Random pastel background
                    const hue = Math.floor(Math.random() * 360);
                    card.style.backgroundColor = `hsl(${hue}, 100%, 95%)`;
                    grid.appendChild(card);
                });
            }

            handleCardClick(el, item) {
                if (this.isLocked) return;

                if (item.word === this.target.word) {
                    // CORRECT
                    this.isLocked = true;
                    el.classList.add('correct');
                    AudioSys.playCorrect();
                    this.score += 10 + (this.hearts * 5); // Bonus score
                    document.getElementById('hud-score').innerText = this.score;
                    
                    // Confetti
                    const rect = el.getBoundingClientRect();
                    const x = (rect.left + rect.width / 2) / window.innerWidth;
                    const y = (rect.top + rect.height / 2) / window.innerHeight;
                    confetti({ particleCount: 100, spread: 70, origin: { x, y } });

                    // Next level logic
                    setTimeout(() => this.completeLevel(), 1500);
                } else {
                    // WRONG
                    el.classList.add('shake');
                    AudioSys.playWrong();
                    this.hearts--;
                    this.updateHUD();
                    setTimeout(() => el.classList.remove('shake'), 500);
                    
                    if (this.hearts <= 0) {
                        setTimeout(() => this.gameOver(), 500);
                    }
                }
            }

            useHint() {
                if (this.hints > 0 && !this.isLocked) {
                    this.hints--;
                    this.updateHUD();
                    
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(c => {
                        if (c.dataset.word === this.target.word) {
                            c.classList.add('hint-active');
                            setTimeout(() => c.classList.remove('hint-active'), 1000);
                        }
                    });
                }
            }

            speakTarget() {
                AudioSys.speak(this.target.word);
            }

            updateHUD() {
                document.getElementById('hud-level').innerText = this.level;
                document.getElementById('hud-score').innerText = this.score;
                document.getElementById('btn-hint').innerText = `üí° ${this.hints}`;
                
                let hStr = "";
                for(let i=0; i<3; i++) hStr += (i < this.hearts ? "‚ù§Ô∏è" : "üñ§");
                document.getElementById('hud-hearts').innerText = hStr;
            }

            completeLevel() {
                this.saveData(this.level, this.score);
                document.getElementById('win-score').innerText = `Score: ${this.score}`;
                this.hideAll();
                document.getElementById('win-screen').classList.remove('hidden');
            }

            gameOver() {
                this.hideAll();
                document.getElementById('lose-screen').classList.remove('hidden');
            }

            nextLevel() {
                if (this.level < this.maxLevel) {
                    this.startLevel(this.level + 1);
                } else {
                    alert("Congratulations! You finished all levels!");
                    this.showMap();
                }
            }

            retryLevel() {
                this.startLevel(this.level);
            }
        }

        // --- INIT ---
        const game = new Game();

    </script>
</body>
</html>
