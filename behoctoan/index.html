<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V∆∞∆°ng Qu·ªëc To√°n H·ªçc - 100 Tr√≤ Ch∆°i</title>
    <style>
        /* =========================================
           1. CSS - GIAO DI·ªÜN & PHONG C√ÅCH
           ========================================= */
        :root {
            --primary: #FF9A9E;       /* H·ªìng Pastel */
            --secondary: #A18CD1;     /* T√≠m Pastel */
            --accent: #FBC2EB;        /* Nh·∫•n */
            --bg-color: #fdfbf7;      /* M√†u kem n·ªÅn */
            --card-bg: #ffffff;
            --text-color: #5d5d5d;
            --success: #84fab0;       /* Xanh l√° - ƒê√∫ng */
            --error: #ff9a9e;         /* ƒê·ªè - Sai */
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
            --shadow-btn: 0 5px 0 rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background: linear-gradient(135deg, #fdfbf7 0%, #fff1eb 100%);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI CHUNG --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s;
        }

        .screen.active {
            display: flex;
            z-index: 10;
        }

        h1, h2 { margin: 0; font-weight: 700; color: var(--secondary); text-align: center; }
        h1 { font-size: 2rem; margin-bottom: 10px; }
        
        .btn {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-circle { width: 50px; height: 50px; padding: 0; border-radius: 50%; }

        /* --- M√ÄN H√åNH MENU (GRID 100 LEVEL) --- */
        #menu-container {
            width: 100%;
            max-width: 800px;
            height: 80vh;
            overflow-y: auto;
            padding: 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.5);
            /* Scrollbar ·∫©n cho ƒë·∫πp */
            scrollbar-width: none; 
        }
        #menu-container::-webkit-scrollbar { display: none; }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
            padding-bottom: 50px;
        }

        .level-btn {
            aspect-ratio: 1;
            background: white;
            border-radius: 15px;
            border: 3px solid transparent;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .level-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .level-btn.completed { background: var(--success); color: white; }
        .level-btn.locked { background: #eee; color: #ccc; cursor: not-allowed; }
        
        /* --- M√ÄN H√åNH GAME --- */
        .game-header {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            flex: 1;
            height: 15px;
            background: #eee;
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        .game-board {
            background: white;
            width: 100%;
            max-width: 600px;
            min-height: 400px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .question-area {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 40px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }

        /* H√¨nh ·∫£nh SVG trong c√¢u h·ªèi */
        .visual-item {
            width: 60px;
            height: 60px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }
        .option-btn {
            background: #f0f4f8;
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #d9e2ec;
        }
        .option-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* Hi·ªáu ·ª©ng ƒê√∫ng/Sai */
        .correct { background: var(--success) !important; color: white !important; border-color: #6fdc98 !important; }
        .wrong { background: var(--error) !important; color: white !important; animation: shake 0.5s; }

        /* --- M√ÄN H√åNH CHI·∫æN TH·∫ÆNG --- */
        #canvas-confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        /* --- ANIMATIONS --- */
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* Icon SVG n·ªôi tuy·∫øn */
        .icon-svg { width: 30px; height: 30px; fill: currentColor; }
        
    </style>
</head>
<body>

    <canvas id="canvas-confetti"></canvas>

    <div id="screen-menu" class="screen active">
        <h1 style="font-size: 2.5rem; color: var(--primary);">üè∞ V∆∞∆°ng Qu·ªëc To√°n H·ªçc</h1>
        <p style="margin-bottom: 20px; color: #888;">Ch·ªçn m√†n ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu kh√°m ph√°!</p>
        
        <div style="margin-bottom: 15px;">
            <button class="btn btn-circle" onclick="AudioManager.toggle()" id="btn-sound">üîä</button>
        </div>

        <div id="menu-container">
            <div class="level-grid" id="level-grid">
                </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="btn btn-circle" onclick="App.goHome()">üè†</button>
            <div class="progress-bar-container">
                <div class="progress-bar" id="game-progress"></div>
            </div>
            <div style="font-weight: bold; font-size: 1.2rem; color: var(--primary);">Lv <span id="current-level-display">1</span></div>
        </div>

        <div class="game-board">
            <div class="question-area" id="question-display">
                </div>
            
            <div id="hint-text" style="height: 20px; color: var(--secondary); margin-bottom: 10px; font-weight: bold;"></div>

            <div class="options-grid" id="options-container">
                </div>
        </div>
    </div>

    <div id="screen-win" class="screen" style="background: rgba(255,255,255,0.9);">
        <h1 style="font-size: 4rem; margin-bottom: 20px;">üéâ</h1>
        <h1 id="win-title" style="color: var(--secondary);">Xu·∫•t s·∫Øc!</h1>
        <p id="win-message" style="font-size: 1.5rem; color: #666; margin-bottom: 40px;">Con l√†m t·ªët l·∫Øm!</p>
        <button class="btn btn-primary" style="font-size: 1.5rem; padding: 20px 50px;" onclick="App.nextLevel()">M√†n ti·∫øp theo ‚û°Ô∏è</button>
    </div>

    <script>
        /**
         * =========================================
         * 2. JAVASCRIPT - GAME ENGINE
         * Kh√¥ng framework - Logic thu·∫ßn
         * =========================================
         */

        /* --- C·∫§U H√åNH & D·ªÆ LI·ªÜU --- */
        const CONFIG = {
            totalLevels: 100,
            questionsPerLevel: 5,
            colors: ['#FF9A9E', '#A18CD1', '#FBC2EB', '#84fab0', '#8fd3f4']
        };

        const SVGS = {
            apple: '<svg viewBox="0 0 512 512" fill="#ff6b6b"><path d="M256 0c-44 0-80 36-80 80 0 32 18 60 45 73-64 12-114 62-126 128H80c-26 0-48 22-48 48s22 48 48 48h10c8 58 55 104 114 111 26 2 52-6 73-22 21 16 47 24 73 22 59-7 106-53 114-111h10c26 0 48-22 48-48s-22-48-48-48h-15c-12-66-62-116-126-128 27-13 45-41 45-73 0-44-36-80-80-80z"/></svg>',
            star: '<svg viewBox="0 0 512 512" fill="#ffd93b"><path d="M256 32l68 142 156 22-113 108 27 154-138-75-138 75 27-154-113-108 156-22z"/></svg>',
            cat: '<svg viewBox="0 0 512 512" fill="#ffb8b8"><path d="M256 192c-70 0-128 58-128 128s58 128 128 128 128-58 128-128-58-128-128-128z"/><path d="M128 192L96 96l96 32zM384 192l32-96-96 32z"/></svg>'
        };

        /* --- QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE) --- */
        const State = {
            currentLevel: 1,
            currentQuestionIndex: 0,
            score: 0,
            unlockedLevel: 1 // M·∫∑c ƒë·ªãnh m·ªü b√†i 1
        };

        /* --- H·ªÜ TH·ªêNG √ÇM THANH (Web Audio API) --- */
        const AudioManager = {
            ctx: null,
            enabled: true,
            
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            toggle() {
                this.enabled = !this.enabled;
                document.getElementById('btn-sound').innerText = this.enabled ? 'üîä' : 'üîá';
            },

            playTone(freq, type, duration) {
                if (!this.enabled) return;
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playCorrect() {
                this.playTone(600, 'sine', 0.1);
                setTimeout(() => this.playTone(800, 'sine', 0.2), 100);
                setTimeout(() => this.playTone(1000, 'sine', 0.4), 200);
            },

            playWrong() {
                this.playTone(200, 'sawtooth', 0.3);
                setTimeout(() => this.playTone(150, 'sawtooth', 0.3), 150);
            },

            playWin() {
                // H·ª£p √¢m chi·∫øn th·∫Øng
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.6), i * 100));
            }
        };

        /* --- LOGIC SINH C√ÇU H·ªéI (QUAN TR·ªåNG) --- */
        const LevelGenerator = {
            // H√†m sinh c√¢u h·ªèi d·ª±a tr√™n level (1 -> 100)
            generate(level) {
                const q = [];
                let type = '';
                
                // PH√ÇN LO·∫†I GAME THEO LEVEL
                if (level <= 10) type = 'COUNTING';       // 1-10: ƒê·∫øm h√¨nh
                else if (level <= 20) type = 'COMPARE';   // 11-20: So s√°nh l·ªõn nh·ªè
                else if (level <= 30) type = 'ADD_EASY';  // 21-30: C·ªông < 10
                else if (level <= 40) type = 'SUB_EASY';  // 31-40: Tr·ª´ < 10
                else if (level <= 50) type = 'ADD_MED';   // 41-50: C·ªông < 20
                else if (level <= 60) type = 'SUB_MED';   // 51-60: Tr·ª´ < 20
                else if (level <= 70) type = 'FIND_MISSING'; // 61-70: ƒêi·ªÅn s·ªë thi·∫øu
                else if (level <= 80) type = 'LOGIC_SHAPE'; // 71-80: Logic h√¨nh
                else if (level <= 90) type = 'MIXED_HARD'; // 81-90: T·ªïng h·ª£p
                else type = 'MASTER';                      // 91-100: Th·ª≠ th√°ch

                for (let i = 0; i < CONFIG.questionsPerLevel; i++) {
                    q.push(this.createQuestion(type, level));
                }
                return q;
            },

            createQuestion(type, level) {
                let question = {}, answer, options = [];
                
                // Helper random
                const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

                switch (type) {
                    case 'COUNTING':
                        answer = rand(1, Math.min(level + 3, 10)); // TƒÉng d·∫ßn s·ªë l∆∞·ª£ng
                        question.html = this.getVisuals('apple', answer);
                        question.text = "C√≥ bao nhi√™u qu·∫£ t√°o?";
                        break;
                    
                    case 'COMPARE':
                        const n1 = rand(1, 10);
                        const n2 = rand(1, 10);
                        if(n1 === n2) answer = '=';
                        else answer = n1 > n2 ? '>' : '<';
                        question.html = `<span style="font-size:4rem">${n1} ? ${n2}</span>`;
                        question.text = "Ch·ªçn d·∫•u ƒë√∫ng";
                        options = ['>', '<', '='];
                        break;

                    case 'ADD_EASY':
                        const a1 = rand(1, 5);
                        const a2 = rand(1, 4);
                        answer = a1 + a2;
                        question.html = `<span style="font-size:4rem">${a1} + ${a2} = ?</span>`;
                        question.text = "Ph√©p c·ªông";
                        break;

                    case 'SUB_EASY':
                        const s1 = rand(2, 9);
                        const s2 = rand(1, s1 - 1);
                        answer = s1 - s2;
                        question.html = `<span style="font-size:4rem">${s1} - ${s2} = ?</span>`;
                        question.text = "Ph√©p tr·ª´";
                        break;
                    
                    // ... C√≥ th·ªÉ m·ªü r·ªông th√™m logic c√°c case kh√°c ·ªü ƒë√¢y ...
                    // M·∫∑c ƒë·ªãnh cho c√°c case cao h∆°n ƒë·ªÉ code ng·∫Øn g·ªçn trong demo
                    default:
                        const max = level < 50 ? 20 : 50;
                        const x = rand(1, max);
                        const y = rand(1, max);
                        const isAdd = Math.random() > 0.5;
                        if(isAdd) {
                            answer = x + y;
                            question.html = `${x} + ${y} = ?`;
                        } else {
                            // ƒê·∫£m b·∫£o tr·ª´ kh√¥ng √¢m
                            const big = Math.max(x,y);
                            const small = Math.min(x,y);
                            answer = big - small;
                            question.html = `${big} - ${small} = ?`;
                        }
                        question.text = "T√≠nh nh·∫©m";
                }

                // T·∫°o ƒë√°p √°n sai (n·∫øu ch∆∞a c√≥ options)
                if (options.length === 0) {
                    options.push(answer);
                    while(options.length < 4) {
                        let wrong = answer + rand(-5, 5);
                        if(wrong >= 0 && !options.includes(wrong)) {
                            options.push(wrong);
                        }
                    }
                    shuffle(options);
                }

                return { question, answer, options };
            },

            getVisuals(type, count) {
                let html = '';
                for(let i=0; i<count; i++) {
                    html += `<div class="visual-item">${SVGS[type] || SVGS.star}</div>`;
                }
                return html;
            }
        };

        /* --- UI RENDERER --- */
        const App = {
            currentQuestions: [],
            
            init() {
                this.renderMenu();
                // Load save data (n·∫øu c√≥ localStorage)
                const saved = localStorage.getItem('math_game_level');
                if(saved) State.unlockedLevel = parseInt(saved);
                this.updateMenuStatus();
            },

            renderMenu() {
                const grid = document.getElementById('level-grid');
                grid.innerHTML = '';
                for (let i = 1; i <= CONFIG.totalLevels; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'level-btn';
                    btn.innerText = i;
                    btn.id = `lvl-${i}`;
                    btn.onclick = () => this.startLevel(i);
                    grid.appendChild(btn);
                }
                this.updateMenuStatus();
            },

            updateMenuStatus() {
                for (let i = 1; i <= CONFIG.totalLevels; i++) {
                    const btn = document.getElementById(`lvl-${i}`);
                    if (i < State.unlockedLevel) {
                        btn.classList.add('completed');
                        btn.innerText = '‚≠ê';
                    } else if (i === State.unlockedLevel) {
                        btn.classList.remove('locked', 'completed');
                        btn.innerText = i;
                    } else {
                        btn.classList.add('locked');
                    }
                }
            },

            startLevel(lvl) {
                if (lvl > State.unlockedLevel) return; // Locked
                
                State.currentLevel = lvl;
                State.currentQuestionIndex = 0;
                this.currentQuestions = LevelGenerator.generate(lvl);
                
                this.switchScreen('screen-game');
                document.getElementById('current-level-display').innerText = lvl;
                this.loadQuestion();
            },

            loadQuestion() {
                const q = this.currentQuestions[State.currentQuestionIndex];
                
                // Update Progress
                const pct = (State.currentQuestionIndex / CONFIG.questionsPerLevel) * 100;
                document.getElementById('game-progress').style.width = `${pct}%`;

                // Render Question
                document.getElementById('question-display').innerHTML = q.question.html;
                document.getElementById('hint-text').innerText = ""; // X√≥a g·ª£i √Ω c≈©

                // Render Options
                const optContainer = document.getElementById('options-container');
                optContainer.innerHTML = '';
                
                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt;
                    btn.onclick = (e) => this.checkAnswer(opt, q.answer, e.target);
                    optContainer.appendChild(btn);
                });
            },

            checkAnswer(selected, correct, btnElement) {
                if (selected == correct) {
                    // ƒê√öNG
                    btnElement.classList.add('correct');
                    AudioManager.playCorrect();
                    Effects.spawnStars(btnElement);

                    // Ch·∫∑n click li√™n ti·∫øp
                    const allBtns = document.querySelectorAll('.option-btn');
                    allBtns.forEach(b => b.disabled = true);

                    setTimeout(() => {
                        State.currentQuestionIndex++;
                        if (State.currentQuestionIndex >= CONFIG.questionsPerLevel) {
                            this.levelComplete();
                        } else {
                            this.loadQuestion();
                        }
                    }, 1000);
                } else {
                    // SAI
                    btnElement.classList.add('wrong');
                    AudioManager.playWrong();
                    document.getElementById('hint-text').innerText = "Th·ª≠ l·∫°i nh√© b√© ∆°i!";
                    setTimeout(() => btnElement.classList.remove('wrong'), 500);
                }
            },

            levelComplete() {
                document.getElementById('game-progress').style.width = '100%';
                AudioManager.playWin();
                Effects.fireworks();
                
                // Unlock level m·ªõi
                if(State.currentLevel === State.unlockedLevel) {
                    State.unlockedLevel++;
                    localStorage.setItem('math_game_level', State.unlockedLevel);
                }

                // Random l·ªùi khen
                const praises = ["Tuy·ªát v·ªùi!", "Xu·∫•t s·∫Øc!", "B√© gi·ªèi qu√°!", "Th√¥ng minh!", "ƒê·ªânh cao!"];
                document.getElementById('win-title').innerText = praises[Math.floor(Math.random()*praises.length)];

                setTimeout(() => {
                    this.switchScreen('screen-win');
                }, 800);
            },

            nextLevel() {
                this.startLevel(State.currentLevel + 1);
            },

            goHome() {
                this.updateMenuStatus();
                this.switchScreen('screen-menu');
            },

            switchScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }
        };

        /* --- EFFECTS ENGINE --- */
        const Effects = {
            canvas: document.getElementById('canvas-confetti'),
            
            spawnStars(element) {
                // T·∫°o hi·ªáu ·ª©ng sao bay ƒë∆°n gi·∫£n quanh n√∫t b·∫•m
                // (Gi·∫£n l∆∞·ª£c cho code ng·∫Øn g·ªçn, d√πng CSS animation ·ªü tr√™n)
            },

            fireworks() {
                const ctx = this.canvas.getContext('2d');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                const particles = [];
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];

                for(let i=0; i<100; i++) {
                    particles.push({
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        life: 100
                    });
                }

                function animate() {
                    ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                    let active = false;
                    particles.forEach(p => {
                        if(p.life > 0) {
                            active = true;
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vy += 0.2; // Gravity
                            p.life--;
                            ctx.fillStyle = p.color;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });
                    if(active) requestAnimationFrame(animate);
                    else ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                }
                animate();
            }
        };

        // B·∫Øt ƒë·∫ßu
        window.onload = () => App.init();

    </script>
</body>
</html>
