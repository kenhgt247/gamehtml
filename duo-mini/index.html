<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Duo-mini HTML5</title>
  <style>
    :root{ --bg:#f6fbff; --card:#fff; --ink:#17212B; --mut:#5b6b7a; --teal:#22c1b8; --pink:#ff5ea8; --y:#ffcc49; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial; background:var(--bg); color:var(--ink); }
    .app{ max-width:720px; margin:0 auto; padding:16px; padding-bottom:calc(16px + env(safe-area-inset-bottom)); }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .pill{ background:#fff; border-radius:999px; padding:8px 10px; font-weight:800; box-shadow:0 10px 22px rgba(0,0,0,.08); }
    .btn{ border:none; border-radius:14px; padding:12px 12px; font-weight:900; background:#fff; box-shadow:0 10px 22px rgba(0,0,0,.08); cursor:pointer; }
    .btn.primary{ background:linear-gradient(135deg,var(--teal),rgba(34,193,184,.75)); }
    .btn.yellow{ background:linear-gradient(135deg,var(--y),rgba(255,204,73,.85)); }
    .card{ background:var(--card); border-radius:18px; padding:14px; box-shadow:0 16px 30px rgba(0,0,0,.10); }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .opt{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; min-height:92px; }
    .e{ font-size:40px; }
    .w{ font-size:13px; color:var(--mut); font-weight:900; }
    .bar{ height:12px; background:#fff; border-radius:999px; overflow:hidden; box-shadow:0 10px 22px rgba(0,0,0,.08); }
    .bar > div{ height:100%; width:0%; background:linear-gradient(90deg,var(--y),var(--pink),var(--teal)); transition:width .2s ease; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; }
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:rgba(23,33,43,.92); color:#fff; padding:10px 12px; border-radius:999px; font-weight:900; opacity:0; transition:.15s; }
    .toast.show{ opacity:1; }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="pill"><b>Duo-mini</b> â€¢ HTML5</div>
      <button class="btn yellow" id="btnStart">START / Enable Sound ğŸ”Š</button>
    </div>

    <div style="margin:12px 0" class="bar"><div id="prog"></div></div>

    <div id="viewHome" class="card">
      <h2 style="margin:0 0 10px">Units</h2>
      <div id="unitList" class="row"></div>
      <div id="lessonList" style="margin-top:12px" class="row"></div>
    </div>

    <div id="viewLesson" class="card" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div style="font-weight:1000" id="lessonTitle">Lesson</div>
          <div style="font-size:13px; font-weight:900; color:var(--mut)" id="stepInfo">Step</div>
        </div>
        <button class="btn" id="btnSpeak">ğŸ”Š</button>
      </div>

      <h3 style="margin:12px 0 10px" id="prompt">Listen and choose</h3>
      <div class="grid" id="choices"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnExit">ğŸ  Home</button>
        <button class="btn primary" id="btnNext" disabled>Next â–¶</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ========= toast ========= */
const toastEl = document.getElementById("toast");
let toastTimer=null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toastEl.classList.remove("show"), 1200);
}

/* ========= iOS sound unlock + TTS ========= */
const AudioSys = {
  ctx:null, muted:false, rate:0.92, voices:[], voicesReady:false,
  init(){
    try{ if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    this.loadVoices();
  },
  async unlock(){
    this.init();
    try{
      if(this.ctx && this.ctx.state==="suspended") await this.ctx.resume();
      if(this.ctx){
        const b=this.ctx.createBuffer(1,1,22050);
        const s=this.ctx.createBufferSource(); s.buffer=b; s.connect(this.ctx.destination); s.start(0);
      }
    }catch(e){}
  },
  loadVoices(){
    const synth = window.speechSynthesis; if(!synth) return;
    const pull=()=>{
      const v = synth.getVoices ? (synth.getVoices()||[]) : [];
      if(v.length){ this.voices=v; this.voicesReady=true; }
    };
    pull();
    try{ synth.onvoiceschanged=()=>pull(); }catch(e){}
    let tries=0; const t=setInterval(()=>{ pull(); if(this.voicesReady||++tries>25) clearInterval(t); },100);
  },
  pickVoice(lang="en-GB"){
    const L=(lang||"").toLowerCase();
    const v=this.voices||[];
    return v.find(x=>((x.lang||"").toLowerCase()===L && x.localService))
        || v.find(x=>((x.lang||"").toLowerCase()===L))
        || v.find(x=>((x.lang||"").toLowerCase().startsWith("en-") && x.localService))
        || v.find(x=>((x.lang||"").toLowerCase().startsWith("en-")))
        || null;
  },
  speak(text, lang="en-GB"){
    if(this.muted) return;
    const synth=window.speechSynthesis;
    if(!synth || typeof SpeechSynthesisUtterance==="undefined"){ toast("No TTS"); return; }
    try{ synth.cancel(); }catch(e){}
    const t=String(text||"").trim(); if(!t) return;
    setTimeout(()=>{
      const u=new SpeechSynthesisUtterance(t);
      u.lang=lang; u.rate=this.rate;
      const voice=this.pickVoice(lang); if(voice) u.voice=voice;
      try{ synth.speak(u); }catch(e){}
    }, 60);
  }
};

/* ========= IndexedDB cache for JSON ========= */
const DB_NAME="duo-mini-db", STORE="kv";
function idb(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=()=> req.result.createObjectStore(STORE);
    req.onsuccess=()=> resolve(req.result);
    req.onerror=()=> reject(req.error);
  });
}
async function kvGet(key){
  const db=await idb();
  return new Promise((resolve)=>{
    const tx=db.transaction(STORE,"readonly");
    const r=tx.objectStore(STORE).get(key);
    r.onsuccess=()=> resolve(r.result || null);
    r.onerror=()=> resolve(null);
  });
}
async function kvSet(key,val){
  const db=await idb();
  return new Promise((resolve)=>{
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).put(val,key);
    tx.oncomplete=()=> resolve(true);
    tx.onerror=()=> resolve(false);
  });
}
async function fetchJSON(url){
  const cacheKey="json:"+url;
  const cached=await kvGet(cacheKey);
  if(cached) return cached;
  const res=await fetch(url, {cache:"no-store"});
  const data=await res.json();
  kvSet(cacheKey,data);
  return data;
}

/* ========= App state ========= */
const ui = {
  btnStart: document.getElementById("btnStart"),
  viewHome: document.getElementById("viewHome"),
  viewLesson: document.getElementById("viewLesson"),
  unitList: document.getElementById("unitList"),
  lessonList: document.getElementById("lessonList"),
  lessonTitle: document.getElementById("lessonTitle"),
  stepInfo: document.getElementById("stepInfo"),
  prompt: document.getElementById("prompt"),
  choices: document.getElementById("choices"),
  btnSpeak: document.getElementById("btnSpeak"),
  btnExit: document.getElementById("btnExit"),
  btnNext: document.getElementById("btnNext"),
  prog: document.getElementById("prog"),
};

let path=null;
let currentUnit=null;
let currentLesson=null;
let stepIndex=0;
let answered=false;

function showHome(){
  ui.viewLesson.style.display="none";
  ui.viewHome.style.display="block";
  ui.lessonList.innerHTML="";
  ui.prog.style.width="0%";
}

function showLesson(){
  ui.viewHome.style.display="none";
  ui.viewLesson.style.display="block";
}

function setProgress(p){
  ui.prog.style.width = Math.round(p*100)+"%";
}

async function loadPath(){
  path = await fetchJSON("./content/path.json");
  renderUnits();
}

function renderUnits(){
  ui.unitList.innerHTML="";
  (path.units||[]).forEach(u=>{
    const b=document.createElement("button");
    b.className="btn";
    b.textContent = u.title;
    b.onclick=()=>{ currentUnit=u; renderLessons(u); };
    ui.unitList.appendChild(b);
  });
}

function renderLessons(unit){
  ui.lessonList.innerHTML="";
  (unit.lessons||[]).forEach(l=>{
    const b=document.createElement("button");
    b.className="btn primary";
    b.textContent = l.title;
    b.onclick=()=> startLesson(l);
    ui.lessonList.appendChild(b);
  });
}

async function startLesson(lessonMeta){
  await AudioSys.unlock();
  currentLesson = await fetchJSON(lessonMeta.pack);
  stepIndex=0;
  answered=false;
  ui.lessonTitle.textContent = currentLesson.title || "Lesson";
  showLesson();
  renderStep();
  toast("Letâ€™s go! â­");
}

function renderStep(){
  const steps = currentLesson.steps || [];
  const step = steps[stepIndex];
  answered=false;
  ui.btnNext.disabled=true;
  ui.choices.innerHTML="";

  ui.stepInfo.textContent = `Step ${stepIndex+1}/${steps.length}`;
  ui.prompt.textContent = step.prompt || "Listen and choose";

  setProgress((stepIndex)/Math.max(1,steps.length));

  // auto speak once
  AudioSys.speak(step.speak || step.prompt || "Listen", step.lang || "en-GB");

  (step.choices||[]).forEach(c=>{
    const btn=document.createElement("button");
    btn.className="btn opt";
    btn.innerHTML = `<div class="e">${c.emoji||"â“"}</div><div class="w">${String(c.label||"").toUpperCase()}</div>`;
    btn.onclick=()=> choose(c.id, step.answer, step.lang || "en-GB");
    ui.choices.appendChild(btn);
  });
}

function choose(id, answer, lang){
  if(answered) return;
  const ok = id === answer;
  answered=true;

  if(ok){
    toast("Correct! âœ…");
    ui.btnNext.disabled=false;
    setProgress((stepIndex+1)/Math.max(1,(currentLesson.steps||[]).length));
  }else{
    toast("Try again ğŸ’ª");
    answered=false; // allow retry
    AudioSys.speak("Try again", lang);
  }
}

ui.btnSpeak.onclick=()=>{
  if(!currentLesson) return;
  const step=(currentLesson.steps||[])[stepIndex];
  AudioSys.speak(step.speak || step.prompt || "Listen", step.lang || "en-GB");
};
ui.btnNext.onclick=()=>{
  const steps=currentLesson.steps||[];
  if(stepIndex < steps.length-1){
    stepIndex++;
    renderStep();
  }else{
    toast("Lesson complete! ğŸ‰");
    showHome();
  }
};
ui.btnExit.onclick=()=> showHome();

ui.btnStart.onclick=async ()=>{
  await AudioSys.unlock();
  toast("Sound enabled ğŸ”Š");
};

/* ========= register SW ========= */
(async function boot(){
  AudioSys.init();
  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("/sw.js"); }catch(e){}
  }
  await loadPath();
  showHome();
})();
</script>
</body>
</html>